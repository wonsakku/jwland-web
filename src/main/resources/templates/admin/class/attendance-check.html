<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sd="http://www.thymeleaf.org/spring-data"
	layout:decorator="layout/layout.html"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<title></title>
    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

</head>
<body>
	<main layout:fragment="content"  role="main">
			
	  <div class="album py-5 bg-light" style="height: 100vh;">
	  	  <div class="row pb-4">
		      <h3 class="col-md-6 col-sm-12">[ [[${className}]] ] 출결관리</h3>
		      <div class="col-md-6 col-sm-12 text-right">
		      	<button class='btn btn-primary btn-sm mr-2' onclick="enrollAttendance()">등록</button>
		      	<select id="class-date-select">
		      	</select>
		      </div>
	  	  </div>
	      <div class="table-responsive text-center">
	        <table class="table table-striped table-sm">
	          <thead>
	            <tr>
	              <th></th>
	              <th>이름</th>
	              <th>닉네임</th>
	              <th>출석</th>
	            </tr>
	          </thead>
	          <tbody id="attendance-table-body">
	          </tbody>
	        </table>
	      </div>
	  </div>
	</main>
</body>

</html>




<script th:inline="javascript">
	
	
	var msg = [[${msg}]];
	if(msg != null && msg != ''){
		alert(msg);
	}
	
	
	var accountSequenceList = new Array();
	const classSequenceNo = [[${classSequenceNo}]];
	const className = [[${className}]];
	const today = getFormatDate();
	
	
	(function() {
		loadEnrolledStudents();
		loadClassDate();
		$("#class-date-select").on("change", function(e){
			var selectedDate = $(this).find("option:selected").val();
			if(selectedDate == null || selectedDate == ''){
				selectedDate = today;
			}
			findAttendanceInfoByDate(selectedDate);
		});

	})();

	
	
	function getFormatDate(){
		var date = new Date();
	    var year = date.getFullYear();              //yyyy
	    var month = (1 + date.getMonth());          //M
	    month = month >= 10 ? month : '0' + month;  //month 두자리로 저장
	    var day = date.getDate();                   //d
	    day = day >= 10 ? day : '0' + day;          //day 두자리로 저장
	    return  year + '' + month + '' + day;       //'-' 추가하여 yyyy-mm-dd 형태 생성 가능
	}
	
	function loadEnrolledStudents() {
		
		var url = "/admin/class/classes/" + classSequenceNo + "/account-infos";
		
		$.ajax({
			url: url,
			type: "GET",
			timeout: 10000,
			success: function(data, xhrStatus, xhr){
				_cb_loadEnrolledStudents(data, xhrStatus, xhr);
			},
			error: function(a, b, c){
				alert("학생 데이터를 로딩하는 중 문제가 발생했습니다.");
			}
		});
	}
	
	function _cb_loadEnrolledStudents(data, xhrStatus, xhr){
		
		var $attendanceTableBody = $("#attendance-table-body");
		$attendanceTableBody.html("");

		var html = "";
		
		for(var i = 0 ; i < data.length ; i++){
			html += "<tr>";
			html += "<td><input type='hidden' class='account-sequence-no' id='account-sequence-no-" + data[i].accountSequenceNo + "' value='" + data[i].accountSequenceNo + "'></td>";
			html += "<td class='name'>" + data[i].name + "</td>";
			html += "<td>" + data[i].nickName + "</td>";
			html += "<td>";
			html += "<select class='status'>";
			html += "<option disabled selected value=''>선택</option>";
			html += "<option value='출석'>출석</option>";
			html += "<option value='지각'>지각</option>";
			html += "<option value='결석'>결석</option>";
			html += "</select>";
			html += "</td>";
			html += "</tr>";
		}
		
		$attendanceTableBody.html(html);
	}
	
	function loadClassDate(){
		var url = "/admin/class/classes/" + classSequenceNo + "/date";
		
		$.ajax({
			url: url,
			type: "GET",
			timeout: 10000,
			success: function(data, xhrStatus, xhr){
				_cb_loadClassDate(data, xhrStatus, xhr);
			},
			error: function(a, b, c){
				alert("학생 데이터를 로딩하는 중 문제가 발생했습니다.");
			}
		});

	}
	
	function _cb_loadClassDate(data, xhrStatus, xhr){
// 		console.log(data);
		
		$("#class-date-select").html("");
		
		var html = "<option value=''>==날짜 선택==</option>";
		for(var i = 0 ; i < data.length ; i++){
			var _date = data[i];
			var year = _date.substr(0,4);
			var month = _date.substr(4,2);
			var day = _date.substr(6,2);
			html += "<option value='" + _date + "'>" + year + "-" + month + "-" + day + "</option>";
		}
		
		$("#class-date-select").html(html);
	}
	
	
	function enrollAttendance() {

		var formData = document.createElement("form");
		
		var hiddenField0 = document.createElement("input");
		hiddenField0.setAttribute("type", "hidden");
		hiddenField0.setAttribute("name", "classSequenceNo");
		hiddenField0.setAttribute("value", classSequenceNo);
		formData.appendChild(hiddenField0);

		var classDate = today;
		
		if($("#class-date-select").val() != null || $("#class-date-select").val() != ''){
			classDate = today;
		}
		
		var hiddenField1 = document.createElement("input");
		hiddenField1.setAttribute("type", "hidden");
		hiddenField1.setAttribute("name", "classDate");
		hiddenField1.setAttribute("value", classDate);
		formData.appendChild(hiddenField1);

		var hiddenField11 = document.createElement("input");
		hiddenField11.setAttribute("type", "hidden");
		hiddenField11.setAttribute("name", "className");
		hiddenField11.setAttribute("value", className);
		formData.appendChild(hiddenField1);

		var tableSize= $("#attendance-table-body").find("tr").length;

		for(var i = 0 ; i < tableSize ; i++){
			
			var trElem = $("#attendance-table-body").find("tr")[i];
			var $option = $(trElem).find(".status option:selected");
			
			if($option.val() == null || $option.val() == ''){
				alert("출결 상태가 선택되지 않은 학생이 있습니다.");
				alert($(item).find(".name").text());
				return false;
			}
			
			var status = $option.val();
			var accountSequenceNo = $(trElem).find(".account-sequence-no").val();

			var hiddenField2 = document.createElement("input");
			hiddenField2.setAttribute("type", "hidden");
			hiddenField2.setAttribute("name", "attendanceInfo[" + i + "].status");
			hiddenField2.setAttribute("value", status);

			var hiddenField3 = document.createElement("input");
			hiddenField3.setAttribute("type", "hidden");
			hiddenField3.setAttribute("name", "attendanceInfo[" + i + "].accountSequenceNo");
			hiddenField3.setAttribute("value", accountSequenceNo);

			formData.appendChild(hiddenField2);
			formData.appendChild(hiddenField3);
		}
		
		if(!confirm("등록하시겠습니까?")){
			return ;
		}
		
		formData.setAttribute("charset", "UTF-8");
		formData.setAttribute("method", "post");
		formData.setAttribute("action", "/admin/class/classes/attendance/enroll");
		
		document.body.appendChild(formData);
		
		formData.submit();
	}
	
	
	function addStudents(){
		
		var formData = document.createElement("form");
		
		var hiddenField = document.createElement("input");
		hiddenField.setAttribute("type", "hidden");
		hiddenField.setAttribute("name", "classSequenceNo");
		hiddenField.setAttribute("value", classSequenceNo);
		formData.appendChild(hiddenField);
		
		for(var i = 0 ; i < accountSequenceList.length ; i++){
			var hiddenField2 = document.createElement("input");
			hiddenField2.setAttribute("type", "hidden");
			hiddenField2.setAttribute("name", "accountSequenceList[" + i + "]");
			hiddenField2.setAttribute("value", accountSequenceList[i]);
			formData.appendChild(hiddenField2);
		}
		
		formData.setAttribute("charset", "UTF-8");
		formData.setAttribute("method", "post");
		formData.setAttribute("action", "/class/classes/student/enroll");
		
		document.body.appendChild(formData);
		
		formData.submit();
	}
	
	function findAttendanceInfoByDate(selectedDate){
// 		console.log(selectedDate);
		var url = "/admin/class/classes/" + classSequenceNo + "/attendance-info?classDate=" + selectedDate;
		$.ajax({
			url: url,
			type: "GET",
			timeout: 10000,
			success: function(data, xhrStatus, xhr){
				_cb_findAttendanceInfoByDate(data, xhrStatus, xhr);
			},
			error: function(a, b, c){
				alert("학생 데이터를 로딩하는 중 문제가 발생했습니다.");
			}
		});

	}
	
	function _cb_findAttendanceInfoByDate(data, xhrStatus, xhr){

		for(var i = 0 ; i < data.length ; i++){
			var _status = data[i].status;
			var $tr = $("#account-sequence-no-" + data[i].accountSequenceNo).closest("tr");
			$tr.find(".status option").each(function(index, item){
				if($(item).val() == _status){
					$(item).prop("selected", "selected");
					return false;
				}
			});
		}

		toggleAttendanceSelectbodDiable();
	}
	
	function toggleAttendanceSelectbodDiable(){
		
		var selected_date = $("#class-date-select").val();
		
		if(selected_date == today || selected_date == null || selected_date == ''){
			$(".status").removeAttr("disabled", "disabled");
		}else{
			$(".status").attr("disabled", "disabled");
		}
	}
	
	
</script>













